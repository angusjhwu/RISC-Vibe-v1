# Program View Panel Implementation Plan

## Overview

Add a new panel to the pipeline visualizer that displays the full program listing with stage indicator letters. Each instruction row shows the letters "FDXMW" (Fetch, Decode, eXecute, Memory, Writeback) on the left side, with letters lighting up when the instruction is currently in that stage.

## Requirements

1. **Full Program Listing**: Display all instructions from the loaded trace with their PC addresses
2. **Scrollable View**: User can scroll through the entire program
3. **Stage Indicator Letters**:
   - Letters "FDXMW" per instruction row on the left side
   - Letters light up (become visible/highlighted) when instruction is in that stage at current cycle
   - Inactive letters are dimmed/grayed out
   - Active letters use stage color scheme (green=valid, gray=invalid, red=stalled, orange=flushed)
   - Font size decreases from F (largest) to W (smallest) for visual hierarchy
4. **Synchronization**: Letters update as user steps through cycles

## Data Analysis

### Current Trace Format
Each cycle contains PC and instruction for all 5 stages:
```json
{
  "if":  {"pc": "0x00000004", "instr": "0x00100113", "valid": true},
  "id":  {"pc": "0x00000000", "instr": "0x00a00093", "valid": true},
  "ex":  {"pc": "0x00000004", "instr": "0x01400113", "valid": true},
  "mem": {"pc": "0x00000000", "instr": "0x00a00093", "valid": true},
  "wb":  {"pc": "0x00000000", "instr": "0x00000000", "valid": false}
}
```

### Required Data for Program Listing
Need to build a list of unique (PC, instruction) pairs from the trace. This can be extracted from cycle data by collecting all IF stage PCs and instructions.

**No trace format changes required** - all data is already available.

## Implementation

### 1. HTML Changes (index.html)

Add program view panel to the bottom section, creating a 3-column layout:

```html
<!-- Bottom Section - update grid to 3 columns -->
<div class="bottom-section">
    <!-- Program View (new) -->
    <section class="program-section">
        <h2>Program</h2>
        <div class="program-container" id="program-container">
            <!-- Generated by JavaScript -->
        </div>
    </section>

    <!-- Register File (existing) -->
    <section class="register-section">
        ...
    </section>

    <!-- Right Panel (existing) -->
    <div class="right-panel">
        ...
    </div>
</div>
```

### 2. CSS Changes (style.css)

#### Layout Update
```css
.bottom-section {
    display: grid;
    grid-template-columns: 280px 1fr 320px;  /* Program | Registers | Controls */
    gap: var(--spacing-lg);
}

@media (max-width: 1100px) {
    .bottom-section {
        grid-template-columns: 1fr 320px;  /* Stack program with registers */
    }
}

@media (max-width: 900px) {
    .bottom-section {
        grid-template-columns: 1fr;  /* Full stack on mobile */
    }
}
```

#### Program Section Styles
```css
.program-section {
    background-color: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-md);
}

.program-container {
    max-height: 400px;
    overflow-y: auto;
    font-family: var(--font-mono);
    font-size: 0.75rem;
}

.program-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-bottom: 1px solid var(--color-gray-100);
}

.program-row:hover {
    background-color: var(--color-gray-50);
}

.program-row.in-pipeline {
    background-color: rgba(22, 163, 74, 0.05);
}
```

#### Stage Letters
```css
.stage-letters {
    display: flex;
    align-items: baseline;
    gap: 1px;
    min-width: 48px;
    font-family: var(--font-mono);
    font-weight: 600;
}

/* Base letter style - dimmed by default */
.stage-letter {
    color: var(--color-gray-300);
    transition: all var(--transition-fast);
}

/* Letter sizes: F (largest) to W (smallest) */
.stage-letter.f { font-size: 0.875rem; }
.stage-letter.d { font-size: 0.8125rem; }
.stage-letter.x { font-size: 0.75rem; }
.stage-letter.m { font-size: 0.6875rem; }
.stage-letter.w { font-size: 0.625rem; }

/* Active letter states - lit up with stage color */
.stage-letter.active {
    color: var(--stage-valid);
}

/* Brightness gradient for active letters */
.stage-letter.f.active { opacity: 1.0; }
.stage-letter.d.active { opacity: 0.9; }
.stage-letter.x.active { opacity: 0.8; }
.stage-letter.m.active { opacity: 0.7; }
.stage-letter.w.active { opacity: 0.6; }

/* Stalled/Flushed/Invalid states */
.stage-letter.stalled { color: var(--stage-stalled); }
.stage-letter.flushed { color: var(--stage-flushed); }
.stage-letter.invalid { color: var(--stage-invalid); }
```

#### Program Address and Instruction
```css
.program-pc {
    color: var(--color-gray-500);
    min-width: 60px;
}

.program-asm {
    color: var(--color-gray-800);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
```

### 3. JavaScript Changes (main.js)

#### New State Variables
```javascript
const state = {
    // ... existing ...
    programListing: [],  // Array of {pc, instr, asm} objects
};
```

#### Build Program Listing (call after trace load)
```javascript
function buildProgramListing() {
    const seen = new Map();  // PC -> {pc, instr, asm}

    // Collect unique instructions from IF stage across all cycles
    for (const cycle of state.cycles) {
        const ifStage = cycle.if;
        if (ifStage && ifStage.valid && ifStage.pc && ifStage.instr) {
            const pc = ifStage.pc;
            if (!seen.has(pc)) {
                seen.set(pc, {
                    pc: pc,
                    instr: ifStage.instr,
                    asm: disasm(ifStage.instr)
                });
            }
        }
    }

    // Sort by PC address
    state.programListing = Array.from(seen.values())
        .sort((a, b) => parseInt(a.pc, 16) - parseInt(b.pc, 16));
}
```

#### Render Program Listing (call once after buildProgramListing)
```javascript
function renderProgramListing() {
    const container = document.getElementById('program-container');
    if (!container) return;

    container.innerHTML = '';

    for (const entry of state.programListing) {
        const row = document.createElement('div');
        row.className = 'program-row';
        row.dataset.pc = entry.pc;

        row.innerHTML = `
            <div class="stage-letters">
                <span class="stage-letter f" data-stage="if">F</span>
                <span class="stage-letter d" data-stage="id">D</span>
                <span class="stage-letter x" data-stage="ex">X</span>
                <span class="stage-letter m" data-stage="mem">M</span>
                <span class="stage-letter w" data-stage="wb">W</span>
            </div>
            <span class="program-pc">${formatPC(entry.pc)}</span>
            <span class="program-asm">${entry.asm}</span>
        `;

        container.appendChild(row);
    }
}
```

#### Update Program Letters (call in renderCycle)
```javascript
function updateProgramLetters(cycle) {
    const stages = ['if', 'id', 'ex', 'mem', 'wb'];
    const hazard = cycle.hazard || {};

    // Build map of PC -> stage info for current cycle
    const pcToStages = new Map();

    for (const stage of stages) {
        const stageData = cycle[stage];
        if (stageData && stageData.pc) {
            const pc = stageData.pc;
            if (!pcToStages.has(pc)) {
                pcToStages.set(pc, []);
            }
            pcToStages.get(pc).push({
                stage: stage,
                valid: stageData.valid,
                stalled: (stage === 'if' && hazard.stall_if) ||
                         (stage === 'id' && hazard.stall_id),
                flushed: (stage === 'id' && hazard.flush_id) ||
                         (stage === 'ex' && hazard.flush_ex)
            });
        }
    }

    // Update all program rows
    const rows = document.querySelectorAll('.program-row');
    for (const row of rows) {
        const pc = row.dataset.pc;
        const stageInfos = pcToStages.get(pc) || [];

        // Update each letter in this row
        const letters = row.querySelectorAll('.stage-letter');
        for (const letter of letters) {
            const stage = letter.dataset.stage;
            const info = stageInfos.find(s => s.stage === stage);

            // Reset classes
            letter.classList.remove('active', 'stalled', 'flushed', 'invalid');

            if (info) {
                if (info.flushed) {
                    letter.classList.add('active', 'flushed');
                } else if (info.stalled) {
                    letter.classList.add('active', 'stalled');
                } else if (info.valid) {
                    letter.classList.add('active');
                } else {
                    letter.classList.add('active', 'invalid');
                }
            }
        }

        // Highlight row if any instruction is in pipeline
        row.classList.toggle('in-pipeline', stageInfos.length > 0);
    }
}
```

#### Integration Points

**In handleFileSelect() after loading cycles:**
```javascript
// After: state.cycles = rangeData.cycles || [];
buildProgramListing();
renderProgramListing();
```

**In renderCycle():**
```javascript
function renderCycle(cycleNum) {
    const cycle = state.cycles[cycleNum];
    if (!cycle) return;

    renderPipelineStages(cycle);
    renderRegisters(cycle);
    renderForwarding(cycle);
    renderHazards(cycle);
    updateProgramLetters(cycle);  // Add this line
}
```

## Files to Modify

| File | Changes |
|------|---------|
| `sim/visualizer/templates/index.html` | Add program section to bottom layout |
| `sim/visualizer/static/css/style.css` | Add program section styles, update grid layout |
| `sim/visualizer/static/js/main.js` | Add program listing logic and letter updates |

## Visual Design

```
┌─────────────────────────────────────────────────────────────────────┐
│  RISC-Vibe Pipeline Visualizer                      [Load Trace]    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐              │
│  │ IF  │ →  │ ID  │ →  │ EX  │ →  │ MEM │ →  │ WB  │              │
│  │0x04 │    │0x00 │    │0x04 │    │0x00 │    │---- │              │
│  │addi │    │addi │    │addi │    │addi │    │---  │              │
│  └─────┘    └─────┘    └─────┘    └─────┘    └─────┘              │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│ Program          │ Register File              │ Controls            │
│ ──────────────── │ ─────────────────────────  │ ────────────────    │
│ Fdxmw 0x00 addi  │ x0  0x00000000  x8  ...    │ ⏮ ◀ ▶ ▶ ⏭         │
│ fDxmw 0x04 addi  │ x1  0x0000000A  x9  ...    │ Cycle: 5 / 22      │
│ fdXmw 0x08 addi  │ x2  0x00000014  x10 ...    │ Speed: ──●── 5 c/s │
│ fdxMw 0x0c add   │ x3  0x0000001E  x11 ...    │                    │
│ fdxmW 0x10 nop   │ ...                        │ Hazard Status      │
│ fdxmw 0x14 ecall │                            │ ○ Stall IF  ...    │
│                  │                            │                    │
│ [scrollable]     │                            │ Forwarding         │
│                  │                            │ A: NONE  B: NONE   │
└─────────────────────────────────────────────────────────────────────┘

Legend:
  F/D/X/M/W = Active letter (uppercase, colored by stage state)
  f/d/x/m/w = Inactive letter (lowercase representation - actually dimmed)
  Letter sizes: F (largest) → W (smallest)
  Letter brightness: F (brightest) → W (dimmest)
```

## Testing Checklist

1. [ ] Load trace file - program listing populates correctly
2. [ ] Step through cycles - letters update to show current pipeline state
3. [ ] Multiple instructions can have lit letters simultaneously (pipeline is full)
4. [ ] Same instruction can have multiple lit letters (when PC appears in multiple stages)
5. [ ] Letter sizes decrease F → W
6. [ ] Letter brightness decreases F → W
7. [ ] Stalled stages show red letters
8. [ ] Flushed stages show orange letters
9. [ ] Invalid stages show gray letters
10. [ ] Program view scrolls when content exceeds height
11. [ ] Rows highlight when instruction is in pipeline
12. [ ] Responsive layout works on narrower screens